name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'

jobs:
  # ============================================
  # Stage 1: Setup - ÏùòÏ°¥ÏÑ± ÏÑ§Ïπò Î∞è Ï∫êÏã±
  # ============================================
  setup:
    name: Setup
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Generate cache key
        id: cache-key
        run: echo "key=node-modules-${{ hashFiles('package.json') }}" >> $GITHUB_OUTPUT

      - name: Restore cache
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: ${{ steps.cache-key.outputs.key }}

      - name: Install dependencies
        if: steps.cache-restore.outputs.cache-hit != 'true'
        run: npm install

      - name: Save cache
        if: steps.cache-restore.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: node_modules
          key: ${{ steps.cache-key.outputs.key }}

  # ============================================
  # Stage 2: Î≥ëÎ†¨ Ïã§Ìñâ (Lint, Test, Audit)
  # ============================================
  lint:
    name: Lint
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: ${{ needs.setup.outputs.cache-key }}
      - name: Type Check
        run: npm run type-check
      - name: Lint
        run: npm run lint

  test:
    name: Test
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: ${{ needs.setup.outputs.cache-key }}
      - name: Run Tests
        run: npm run test -- --reporter=verbose

  audit:
    name: Audit
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 5
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: ${{ needs.setup.outputs.cache-key }}
      - name: Security Audit
        run: npm audit --audit-level=high || true

  # ============================================
  # Stage 3: Build
  # ============================================
  build:
    name: Build
    needs: [setup, lint, test]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: ${{ needs.setup.outputs.cache-key }}
      - name: Build
        run: npm run build
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: .next
          retention-days: 7

  # ============================================
  # Deploy Dev - develop branch push
  # ============================================
  deploy-dev:
    name: Deploy to Dev
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    steps:
      - name: Trigger Jenkins Dev Deployment via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          JENKINS_USER: ${{ secrets.JENKINS_USER }}
          JENKINS_API_TOKEN: ${{ secrets.JENKINS_API_TOKEN }}
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: JENKINS_USER,JENKINS_API_TOKEN
          script: |
            echo "Triggering Jenkins job commu-dev via localhost..."

            JENKINS_LOCAL="http://localhost:8888"

            # Try without CSRF first
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
              -u "${JENKINS_USER}:${JENKINS_API_TOKEN}" \
              "${JENKINS_LOCAL}/job/commu-dev/build")

            if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "200" ]; then
              echo "Build triggered successfully (HTTP $HTTP_CODE)"
              exit 0
            fi

            # If 403, try with CSRF crumb
            if [ "$HTTP_CODE" = "403" ]; then
              echo "Got 403, trying with CSRF crumb..."

              CRUMB=$(curl -s -u "${JENKINS_USER}:${JENKINS_API_TOKEN}" \
                "${JENKINS_LOCAL}/crumbIssuer/api/json" | jq -r '.crumb // empty')

              if [ -n "$CRUMB" ]; then
                curl -X POST \
                  -u "${JENKINS_USER}:${JENKINS_API_TOKEN}" \
                  -H "Jenkins-Crumb: $CRUMB" \
                  "${JENKINS_LOCAL}/job/commu-dev/build" \
                  --fail --show-error
                echo "Build triggered with CSRF crumb"
              else
                echo "Failed to get CSRF crumb"
                exit 1
              fi
            else
              echo "Unexpected HTTP code: $HTTP_CODE"
              exit 1
            fi

      - name: Notify Slack - Dev Deployed
        if: success()
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
            -H "Content-Type: application/json" \
            -d '{
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üöÄ Commu Dev Î∞∞Ìè¨ ÏãúÏûë",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\ndevelop"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n`${{ github.sha }}`"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Commit Message:*\n${{ github.event.head_commit.message }}"
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "üë§ *Author:* ${{ github.actor }} | üîó <https://dev-commu.shaul.link|Dev Server>"
                    }
                  ]
                }
              ]
            }'

  # ============================================
  # Deploy Prod - main branch push (ÏàòÎèô ÏäπÏù∏ ÌïÑÏöî)
  # ============================================
  notify-prod-ready:
    name: Notify Production Ready
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Send Slack Notification
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
            -H "Content-Type: application/json" \
            -d '{
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚úÖ Commu Production Î∞∞Ìè¨ Ï§ÄÎπÑ ÏôÑÎ£å",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\nmain"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n`${{ github.sha }}`"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Commit Message:*\n${{ github.event.head_commit.message }}"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*CI Status:*\n‚úÖ Lint ÌÜµÍ≥º\n‚úÖ Test ÌÜµÍ≥º\n‚úÖ Build ÏÑ±Í≥µ"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n${{ github.actor }}"
                    }
                  ]
                },
                {
                  "type": "divider"
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "üöÄ Jenkins Î∞∞Ìè¨",
                        "emoji": true
                      },
                      "style": "primary",
                      "url": "https://jenkins.shaul.link/job/commu-prod/",
                      "action_id": "jenkins_deploy"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "üìã Î≥ÄÍ≤ΩÏÇ¨Ìï≠",
                        "emoji": true
                      },
                      "url": "https://github.com/${{ github.repository }}/commit/${{ github.sha }}",
                      "action_id": "view_changes"
                    }
                  ]
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "‚ö†Ô∏è Production Î∞∞Ìè¨Îäî JenkinsÏóêÏÑú ÏàòÎèôÏúºÎ°ú ÏßÑÌñâÌï¥Ï£ºÏÑ∏Ïöî. | üîó <https://commu.shaul.link|Production Server>"
                    }
                  ]
                }
              ]
            }'
